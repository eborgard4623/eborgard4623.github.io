<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />

    <title>Criminalization of Homosexuality by Country</title>

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/normalize/5.0.0/normalize.min.css"
    />

    <link rel="stylesheet" href="styles.css" />

    

    <script>
      window.console = window.console || function (t) {};
    </script>

    <script>
      if (document.location.search.match(/type=embed/gi)) {
        window.parent.postMessage("resize", "*");
      }
    </script>
  </head>

  <body translate="no">
    <!DOCTYPE html>
    <meta charset="utf-8" />

    <script src="https://d3js.org/d3.v4.js"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
    <script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>

    <!-- map begins here -->
    <div class="map">
      <h1>Criminalization of Homosexuality by Country</h1>
      <p id="disclosure">Please note: "legal" does not mean LGBTQ+ persons are protected, only that there are no active written laws declaring homosexuality a crime.</p>
      <p id="links"> <a href="https://docs.google.com/document/d/1BdmG6GhN81pWPu9NweImqz-AEeI3RKvN/edit?usp=sharing&ouid=114433681223033586638&rtpof=true&sd=true">Write up Document</a> 
        <a href="https://youtu.be/CzCde_72Y5o">Youtube Video</a> </p>
  
      <svg id="my_dataviz" width="1100" height="750"></svg>
    </div>
    
    <script src="https://cpwebassets.codepen.io/assets/common/stopExecutionOnTimeout-1b93190375e9ccc259df3a57c1abc0e64599724ae30d7ea4c6877eb615f89387.js"></script>

    <script id="rendered-js">
      // initial setup
      const svg = d3.select("svg"),
        width = svg.attr("width"),
        height = svg.attr("height"),
        path = d3.geoPath(),
        data = d3.map(),
        worldmap =
          "https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson",
        worldpopulation =
          "https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world_population.csv";

      let centered, world;

      // style of geographic projection and scaling
      const projection = d3
        .geoRobinson()
        .scale(180)
        .translate([width / 2, height / 2.25]);

      // Define color scale
      const colorScale = d3
        .scaleThreshold()
        .domain([ 1, 2, 3, 4])
        .range([
          // "#000",
          "#64c987",
          "#fafa6e",
          "#ea1c1c",
          "#808080",
        ]);

      // add tooltip
      const tooltip = d3
        .select("body")
        .append("div")
        .attr("class", "tooltip")
        .style("opacity", 0);

      // Load external data and boot
      d3.queue()
        .defer(d3.json, worldmap)
        .defer(d3.csv, "safety.csv", function (d) {
          data.set(d.code, +d.total);
        })
        .await(ready);

      // Add clickable background
      svg
        .append("rect")
        .attr("class", "background")
        .attr("width", width)
        .attr("height", height)
        .on("click", click);

      // ----------------------------
      //Start of Choropleth drawing
      // ----------------------------

      function ready(error, topo) {
        // topo is the data received from the d3.queue function (the world.geojson)
        // the data from world_population.csv (country code and country population) is saved in data variable

        let mouseOver = function (d) {
          d3.selectAll(".Country")
            .transition()
            .duration(200)
            .style("opacity", 0.5)
            .style("stroke", "transparent");
          d3.select(this)
            .transition()
            .duration(200)
            .style("opacity", 1)
            .style("stroke", "black");
          tooltip
            .style("left", d3.event.pageX + 15 + "px")
            .style("top", d3.event.pageY - 28 + "px")
            .transition()
            .duration(400)
            .style("opacity", 1)
            .text(d.properties.name + ": " + d.total + "");
        };

        let mouseLeave = function () {
          d3.selectAll(".Country")
            .transition()
            .duration(200)
            .style("opacity", 1)
            .style("stroke", "transparent");
          tooltip.transition().duration(300).style("opacity", 0);
        };

        // Draw the map
        world = svg.append("g").attr("class", "world");
        world
          .selectAll("path")
          .data(topo.features)
          .enter()
          .append("path")
          // draw each country
          // d3.geoPath() is a built-in function of d3 v4 and takes care of showing the map from a properly formatted geojson file, if necessary filtering it through a predefined geographic projection
          .attr("d", d3.geoPath().projection(projection))

          //retrieve the name of the country from data
          .attr("data-name", function (d) {
            return d.properties.name;
          })

          // set the color of each country
          .attr("fill", function (d) {
            d.total = data.get(d.id) || 0;
            return colorScale(d.total);
          })

          // add a class, styling and mouseover/mouseleave and click functions
          .style("stroke", "transparent")
          .attr("class", function (d) {
            return "Country";
          })
          .attr("id", function (d) {
            return d.id;
          })
          .style("opacity", 1)
          .on("mouseover", mouseOver)
          .on("mouseleave", mouseLeave)
          .on("click", click);

        // Legend
        const x = d3.scaleLinear().domain([-3, 6]);

        const legend = svg.append("g").attr("id", "legend");

        const legend_entry = legend
          .selectAll("g.legend")
          .data(
            colorScale.range().map(function (d) {
              d = colorScale.invertExtent(d);
              if (d[0] == null) d[0] = x.domain()[0];
              if (d[1] == null) d[1] = x.domain()[1];
              return d;
            })
          )
          .enter()
          .append("g")
          .attr("class", "legend_entry");

        const ls_w = 20,
          ls_h = 20;

        legend_entry
          .append("rect")
          .attr("x", 20)
          .attr("y", function (d, i) {
            return height - i * ls_h - 9 * ls_h;
          })
          .attr("width", ls_w)
          .attr("height", ls_h)
          .style("fill", function (d) {
            return colorScale(d[0]);
          })
          .style("opacity", 0.8);

        legend_entry
          .append("text")
          .attr("x", 50)
          .attr("y", function (d, i) {
            return height - i * ls_h - 8.25 * ls_h;
          })
          .text(function (d, i) {
            if (i == 0) return "legal - 0";
            if (i == 1) return "illegal - 1";
            if (i == 2) return "punishable by death - 2";
            if (i == 3) return "Unknown - 4";
          });

        legend
          .append("text")
          .attr("x", 15)
          .attr("y", 500)
          .text("Legend");
      }

      // Zoom functionality
      function click(d) {
        var x, y, k;

        if (d && centered !== d) {
          var centroid = path.centroid(d);
          x = -(centroid[0] * 6);
          y = centroid[1] * 6;
          k = 3;
          centered = d;
        } else {
          x = 0;
          y = 0;
          k = 1;
          centered = null;
        }

        world.selectAll("path").classed(
          "active",
          centered &&
            function (d) {
              return d === centered;
            }
        );

        world
          .transition()
          .duration(750)
          .attr("transform", "translate(" + x + "," + y + ") scale(" + k + ")");
      }
    </script>

    <!-- explanation begins here -->
    <section id="data-exp">
      
      
    </section>
  </body>
</html>
